<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NanoBanana Fix Verification</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #0a0a0a;
            color: #00ff00;
        }
        .test-card {
            background: #1a1a1a;
            border: 2px solid #00ff00;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
        }
        .success { color: #00ff00; font-weight: bold; }
        .error { color: #ff0000; font-weight: bold; }
        .info { color: #00ffff; }
        .warning { color: #ffff00; }
        button {
            background: #00ff00;
            color: #000;
            border: none;
            padding: 10px 20px;
            font-family: monospace;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            border-radius: 5px;
            margin: 5px;
        }
        button:hover {
            background: #00cc00;
        }
        #results {
            background: #000;
            padding: 15px;
            border-radius: 5px;
            white-space: pre-wrap;
            font-size: 12px;
            max-height: 400px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>🍌 NanoBanana Fix Verification</h1>

    <div class="test-card">
        <h2>修正内容の確認</h2>
        <ul>
            <li class="success">✅ 環境検出を「Unknown Environment」として扱うよう修正</li>
            <li class="success">✅ API認証ヘッダーを直接設定（Bearer sk-YOUWARE）</li>
            <li class="success">✅ callYouWareAPIを直接fetchに置き換え</li>
            <li class="success">✅ source_code (11)の成功パターンを適用</li>
        </ul>
    </div>

    <div class="test-card">
        <h2>テスト実行</h2>
        <button onclick="testDirectAPI()">1. Direct API Test (成功パターン)</button>
        <button onclick="testWithYwConfig()">2. ywConfig確認</button>
        <button onclick="testImageGeneration()">3. 画像生成テスト</button>
        <button onclick="clearResults()">Clear</button>
    </div>

    <div class="test-card">
        <h2>結果ログ</h2>
        <div id="results"></div>
    </div>

    <script>
        const resultsDiv = document.getElementById('results');

        function log(message, type = 'info') {
            const timestamp = new Date().toISOString().substr(11, 12);
            const color = {
                success: '#00ff00',
                error: '#ff0000',
                warning: '#ffff00',
                info: '#00ffff'
            }[type] || '#ffffff';

            resultsDiv.innerHTML += `<span style="color: ${color}">[${timestamp}] ${message}</span>\n`;
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function clearResults() {
            resultsDiv.innerHTML = '';
            log('ログクリア', 'info');
        }

        async function testDirectAPI() {
            log('========== Direct API Test Start ==========', 'info');

            try {
                const requestBody = {
                    model: 'nano-banana',
                    prompt: 'Test: Generate a simple geometric shape for verification',
                    n: 1,
                    response_format: 'b64_json'
                };

                log('Sending request to: https://api.youware.com/public/v1/ai/images/generations', 'info');
                log('Headers: Authorization: Bearer sk-YOUWARE', 'info');
                log('Model: nano-banana', 'info');

                const response = await fetch('https://api.youware.com/public/v1/ai/images/generations', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer sk-YOUWARE'
                    },
                    body: JSON.stringify(requestBody)
                });

                log(`Response Status: ${response.status} ${response.statusText}`,
                    response.ok ? 'success' : 'error');

                if (response.ok) {
                    const data = await response.json();
                    log('✅ SUCCESS! NanoBanana API is working correctly!', 'success');
                    log(`Response keys: ${Object.keys(data).join(', ')}`, 'info');

                    if (data.data && data.data[0]) {
                        log('✅ Image data received successfully', 'success');
                        log(`Image format: ${data.data[0].b64_json ? 'base64' : 'url'}`, 'info');
                    }
                } else {
                    const errorText = await response.text();
                    log(`❌ Error: ${errorText}`, 'error');

                    // エラー詳細を解析
                    try {
                        const errorData = JSON.parse(errorText);
                        if (errorData.error?.code === 40101) {
                            log('❌ Authentication error (40101) - 修正が必要です', 'error');
                        }
                    } catch (e) {}
                }

            } catch (error) {
                log(`❌ Network error: ${error.message}`, 'error');
            }

            log('========== Direct API Test End ==========', 'info');
        }

        async function testWithYwConfig() {
            log('========== ywConfig Check Start ==========', 'info');

            // ywConfigをセットアップ
            if (!window.ywConfig && !globalThis.ywConfig) {
                globalThis.ywConfig = {
                    name: "maps-to-cad-illustrator",
                    version: "0.0.0",
                    project_type: "react",
                    ai_config: {
                        isometric_generator: { model: "nano-banana", response_format: "b64_json", n: 1 },
                        hologram_generator: { model: "nano-banana", response_format: "b64_json", n: 1 },
                        line_art_generator: { model: "nano-banana", response_format: "b64_json", n: 1 }
                    }
                };
                log('✅ ywConfig created', 'success');
            } else {
                log('✅ ywConfig already exists', 'success');
            }

            const config = globalThis.ywConfig || window.ywConfig;
            log(`AI Configs: ${Object.keys(config.ai_config).join(', ')}`, 'info');
            log(`All using model: ${config.ai_config.isometric_generator.model}`, 'info');

            log('========== ywConfig Check End ==========', 'info');
        }

        async function testImageGeneration() {
            log('========== Image Generation Test Start ==========', 'info');

            const scenarios = [
                { type: 'isometric', prompt: 'Create an isometric 3D building block' },
                { type: 'hologram', prompt: 'Create a holographic projection' },
                { type: 'line_art', prompt: 'Create a line art drawing' }
            ];

            for (const scenario of scenarios) {
                log(`Testing ${scenario.type}...`, 'info');

                try {
                    const response = await fetch('https://api.youware.com/public/v1/ai/images/generations', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer sk-YOUWARE'
                        },
                        body: JSON.stringify({
                            model: 'nano-banana',
                            prompt: scenario.prompt,
                            n: 1,
                            response_format: 'b64_json'
                        })
                    });

                    if (response.ok) {
                        log(`✅ ${scenario.type}: SUCCESS (Status ${response.status})`, 'success');
                    } else {
                        log(`❌ ${scenario.type}: FAILED (Status ${response.status})`, 'error');
                    }
                } catch (error) {
                    log(`❌ ${scenario.type}: Network error`, 'error');
                }
            }

            log('========== Image Generation Test End ==========', 'info');
        }

        // 初期メッセージ
        window.addEventListener('load', () => {
            log('🚀 NanoBanana Fix Verification Tool Ready', 'success');
            log('修正が正しく適用されているか確認してください', 'info');
            log('YouWareにアップロード後、このHTMLファイルを開いてテストを実行してください', 'warning');
        });
    </script>
</body>
</html>